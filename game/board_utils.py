from collections import namedtuple
import random

# Define a Move structure
Move = namedtuple('Move', ['from_idx', 'to_idx', 'card_slot'])


CARDS = {
        0: {
            "name": "Tiger",
            "pattern": [(-2, 0), (1, 0)]
        },
        1: {
            "name": "Dragon",
            "pattern": [(-1, -2), (-1, 2), (1, -1), (1, 1)]
        },
        2: {
            "name": "Frog",
            "pattern": [(-1, -1), (0, -2), (1, 1)]
        },
        3: {
            "name": "Rabbit",
            "pattern": [(-1, 1), (0, 2), (1, -1)]
        },
        4: {
            "name": "Crab",
            "pattern": [(-1, 0), (0, -2), (0, 2)]
        }, 
        5: {
            "name": "Elephant",
            "pattern": [(-1, -1), (-1, 1), (0, -1), (0, 1)]
        }, 
        6: {
            "name": "Goose",
            "pattern":  [(-1, -1), (0, -1), (0, 1), (1, 1)]
        },
        7: {
            "name": "Rooster",
            "pattern":  [(-1, 1), (0, -1), (0, 1), (1, -1)]
        }, 
        8: {
            "name": "Monkey",
            "pattern":   [(-1, -1), (-1, 1), (1, -1), (1, 1)]
        }, 
        9: {
            "name": "Mantis",
            "pattern":  [(-1, -1), (-1, 1), (1, 0)]
        },
        10: {
            "name": "Horse",
            "pattern":  [(-1, 0), (0, -1), (1, 0)]
        },
        11: {
            "name": "Ox",
            "pattern":  [(-1, 0), (0, 1), (1, 0)]
        },
        12: {
            "name": "Crane",
            "pattern":  [(-1, 0), (1, -1), (1, 1)]
        },
        13: {
            "name": "Boar",
            "pattern":  [(-1, 0), (0, -1), (0, 1)]
        },
        14: {
            "name": "Eel",
            "pattern":  [(-1, -1), (0, 1), (1, -1)]
        },
        15: {
            "name": "Cobra",
            "pattern":  [(-1, 1), (0, -1), (1, 1)]  
        }
}


def get_card_str(card_id):
    """Returns a list of 5 strings representing the card's move pattern."""
    if card_id is None: return ["     "] * 5
    
    offsets = CARDS[card_id]["pattern"] 
    lines = []
    for r in range(5):
        line = ""
        for c in range(5):
            dr, dc = r - 2, c - 2
            
            if dr == 0 and dc == 0:
                line += " @ " 
            elif (dr, dc) in offsets:
                line += " X " 
            else:
                line += " . "
        lines.append(line)
    return lines

'''
def precompute_move_tables(cards_dict):
    # Returns an array/list where index is card_id
    tables = [None] * 16
    for card_id, offsets in cards_dict.items():
        card_masks = []
        for i in range(25):
            mask = 0
            row, col = divmod(i, 5)
            for dr, dc in offsets:
                nr, nc = row + dr, col + dc
                if 0 <= nr < 5 and 0 <= nc < 5:
                    mask |= (1 << (nr * 5 + nc))
            card_masks.append(mask)
        tables[card_id] = card_masks
    return tables

MOVE_TABLES = precompute_move_tables(CARDS)
'''

MOVES = [
    [32, 64, 128, 256, 512, 1024, 2048, 4096, 8192, 16384, 32769, 65538, 131076, 262152, 524304, 1048608, 2097216, 4194432, 8388864, 16777728, 1024, 2048, 4096, 8192, 16384], 
    [64, 160, 320, 640, 256, 2052, 5128, 10257, 20482, 8196, 65664, 164096, 328224, 655424, 262272, 2101248, 5251072, 10503168, 20973568, 8392704, 131072, 262144, 557056, 65536, 131072], 
    [64, 128, 257, 514, 4, 2048, 4097, 8226, 16452, 136, 65536, 131104, 263232, 526464, 4352, 2097152, 4195328, 8423424, 16846848, 139264, 0, 32768, 1114112, 2228224, 4456448], 
    [4, 40, 80, 128, 256, 130, 1284, 2568, 4112, 8192, 4160, 41088, 82176, 131584, 262144, 133120, 1314816, 2629632, 4210688, 8388608, 4259840, 8519680, 17039360, 524288, 0],
    [4, 8, 17, 2, 4, 129, 258, 548, 72, 144, 4128, 8256, 17536, 2304, 4608, 132096, 264192, 561152, 73728, 147456, 4227072, 8454144, 17956864, 2359296, 4718592],
    [2, 5, 10, 20, 8, 66, 165, 330, 660, 264, 2112, 5280, 10560, 21120, 8448, 67584, 168960, 337920, 675840, 270336, 2162688, 5406720, 10813440, 21626880, 8650752],
    [66, 133, 266, 532, 8, 2112, 4257, 8514, 17028, 264, 67584, 136224, 272448, 544896, 8448, 2162688, 4359168, 8718336, 17436672, 270336, 2097152, 5275648, 10551296, 21102592, 8650752], 
    [2, 37, 74, 148, 264, 66, 1188, 2376, 4752, 8448, 2112, 38016, 76032, 152064, 270336, 67584, 1216512, 2433024, 4866048, 8650752, 2162688, 5373952, 10747904, 21495808, 8388608], 
    [64, 160, 320, 640, 256, 2050, 5125, 10250, 20500, 8200, 65600, 164000, 328000, 656000, 262400, 2099200, 5248000, 10496000, 20992000, 8396800, 65536, 163840, 327680, 655360, 262144], 
    [32, 64, 128, 256, 512, 1026, 2053, 4106, 8212, 16392, 32832, 65696, 131392, 262784, 524544, 1050624, 2102272, 4204544, 8409088, 16785408, 65536, 163840, 327680, 655360, 262144], 
    [32, 65, 130, 260, 520, 1025, 2082, 4164, 8328, 16656, 32800, 66624, 133248, 266496, 532992, 1049600, 2131968, 4263936, 8527872, 17055744, 32768, 1114112, 2228224, 4456448, 8912896], 
    [34, 68, 136, 272, 512, 1089, 2178, 4356, 8712, 16400, 34848, 69696, 139392, 278784, 524800, 1115136, 2230272, 4460544, 8921088, 16793600, 2129920, 4259840, 8519680, 17039360, 524288], 
    [64, 160, 320, 640, 256, 2049, 5122, 10244, 20488, 8208, 65568, 163904, 327808, 655616, 262656, 2098176, 5244928, 10489856, 20979712, 8404992, 32768, 65536, 131072, 262144, 524288], 
    [2, 5, 10, 20, 8, 65, 162, 324, 648, 272, 2080, 5184, 10368, 20736, 8704, 66560, 165888, 331776, 663552, 278528, 2129920, 5308416, 10616832, 21233664, 8912896], 
    [2, 36, 72, 144, 256, 64, 1153, 2306, 4612, 8200, 2048, 36896, 73792, 147584, 262400, 65536, 1180672, 2361344, 4722688, 8396800, 2097152, 4227072, 8454144, 16908288, 262144], 
    [64, 129, 258, 516, 8, 2050, 4132, 8264, 16528, 256, 65600, 132224, 264448, 528896, 8192, 2099200, 4231168, 8462336, 16924672, 262144, 65536, 1179648, 2359296, 4718592, 8388608]
]

def get_5_random_cards():
    all_cards = list(range(len(CARDS)))
    random.shuffle(all_cards)
    chosen_cards = all_cards[:5]

    return chosen_cards


def get_5_cards_with_fixed_start(blue : bool):
    length = len(CARDS)
    side_card = random.randint(0, length // 2 - 1) * 2 + (1 - blue)

    all_cards = list(range(length))
    all_cards.remove(side_card)
    random.shuffle(all_cards)
    chosen_cards = all_cards[:4]

    return chosen_cards + [side_card]
    